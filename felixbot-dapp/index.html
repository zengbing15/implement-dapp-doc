<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.5">
<title data-react-helmet="true">A  DApp demo:  Felix bot | Develop your first DApp</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://zengbing15.github.io/implement-dapp-docs/felixbot-dapp"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="A  DApp demo:  Felix bot | Develop your first DApp"><meta data-react-helmet="true" name="description" content="Wow , 你已经理解了CKB 相关的重要概念以及如何使用 lumos 开发 DApp，是时候来开发一个稍微复杂一些的 DApp demo 了~"><meta data-react-helmet="true" property="og:description" content="Wow , 你已经理解了CKB 相关的重要概念以及如何使用 lumos 开发 DApp，是时候来开发一个稍微复杂一些的 DApp demo 了~"><link data-react-helmet="true" rel="shortcut icon" href="/implement-dapp-docs/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://zengbing15.github.io/implement-dapp-docs/felixbot-dapp"><link data-react-helmet="true" rel="alternate" href="https://zengbing15.github.io/implement-dapp-docs/felixbot-dapp" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://zengbing15.github.io/implement-dapp-docs/felixbot-dapp" hreflang="x-default"><link rel="stylesheet" href="/implement-dapp-docs/assets/css/styles.617e16b0.css">
<link rel="preload" href="/implement-dapp-docs/assets/js/runtime~main.23805c1f.js" as="script">
<link rel="preload" href="/implement-dapp-docs/assets/js/main.5e6e0b34.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/implement-dapp-docs/"><b class="navbar__title">Develop your first DApp</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/zengbing15/implement-dapp-docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Docs GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/implement-dapp-docs/">Overview</a></li><li class="menu__list-item"><a class="menu__link" href="/implement-dapp-docs/before-we-get-started">Before We Get Started</a></li><li class="menu__list-item"><a class="menu__link" href="/implement-dapp-docs/rpc-and-transaction">RPC and Transaction</a></li><li class="menu__list-item"><a class="menu__link" href="/implement-dapp-docs/transfer-tx-dapp-demo">A transfer-tx DApp demo</a></li><li class="menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/implement-dapp-docs/felixbot-dapp">A  DApp demo:  Felix bot</a></li><li class="menu__list-item"><a class="menu__link" href="/implement-dapp-docs/felixbot-confirm-message">Felix bot: Confirm signing message</a></li><li class="menu__list-item"><a class="menu__link" href="/implement-dapp-docs/conclusion">Conclusion</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="markdown"><header><h1>A  DApp demo:  Felix bot</h1></header><p>Wow , 你已经理解了CKB 相关的重要概念以及如何使用 lumos 开发 DApp，是时候来开发一个稍微复杂一些的 DApp demo 了~</p><p>Felix bot 基于 <a href="https://github.com/botgram/botgram" target="_blank" rel="noopener noreferrer">botgram</a> 开发的，可以给 telegram group member 发送 CKB 红包。实际上这个 DApp demo 也需要实现转账交易，只不过除了转账交易还会有其他与 CKB 交互的需求。为了更加直观理解 DApp 客户端，后端，与CKB layer1 之间的交互，你可以一边运行 felix bot 一边来看相关代码。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="prerequisites"></a>Prerequisites<a class="hash-link" href="#prerequisites" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="set-up-the-development-environment"></a>Set up the Development Environment<a class="hash-link" href="#set-up-the-development-environment" title="Direct link to heading">#</a></h3><p>请参考 <a href="https://cryptape.github.io/lumos-doc/docs/preparation/setupsystem" target="_blank" rel="noopener noreferrer">Set Up the Development Environment</a>  根据你的 Operating System 配置开发环境。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="prepare-three-ckb-accounts"></a>Prepare three CKB accounts<a class="hash-link" href="#prepare-three-ckb-accounts" title="Direct link to heading">#</a></h3><p> Create three accounts: Alice and Bob and Charlie，see <a href="https://cryptape.github.io/lumos-doc/docs/preparation/createaccount" target="_blank" rel="noopener noreferrer">Create Accounts</a>. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="设置-alice-作为-devchain-的-miner-to-get-capacity"></a>设置 Alice 作为 DevChain 的 miner to get capacity<a class="hash-link" href="#设置-alice-作为-devchain-的-miner-to-get-capacity" title="Direct link to heading">#</a></h3><p>see <a href="https://cryptape.github.io/lumos-doc/docs/reference/ckbaccount#step-5-get-ckb-capacity-for-the-account-of-alice" target="_blank" rel="noopener noreferrer">Step 5. Get CKB capacity for the account of Alice</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="use-ckb-cli--to-transfer-some-ckb-tokens-to-bob"></a>Use CKB-CLI  to transfer some CKB tokens to Bob<a class="hash-link" href="#use-ckb-cli--to-transfer-some-ckb-tokens-to-bob" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ ckb-cli --from-account &lt;ALICE&#x27;s lock_arg&gt; --to-address &lt;Bob&#x27;s address&gt; --capacity &lt;capacity&gt; --tx-fee &lt;tx-fee || 0.01&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Bob 作为转账交易的发送方，Charlie 则是接收方</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="set-up-a-telegram-bot"></a>Set up a telegram bot<a class="hash-link" href="#set-up-a-telegram-bot" title="Direct link to heading">#</a></h3><ul><li>Create a telegram bot, see <a href="https://core.telegram.org/bots#3-how-do-i-create-a-bot" target="_blank" rel="noopener noreferrer">3. How do I create a bot?</a></li><li>Send a list of commands to BotFather </li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">start - start</span></span><span class="token-line" style="color:#393A34"><span class="token plain">help - help</span></span><span class="token-line" style="color:#393A34"><span class="token plain">set_receiving_address - Set receiving address</span></span><span class="token-line" style="color:#393A34"><span class="token plain">receiving_address - Get receiving address</span></span><span class="token-line" style="color:#393A34"><span class="token plain">pending_envelopes - List of pending envelopes sent by me</span></span><span class="token-line" style="color:#393A34"><span class="token plain">pay - Pay an envelope</span></span><span class="token-line" style="color:#393A34"><span class="token plain">send - send envelopes</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="run-the-felix-bot"></a>Run the felix bot<a class="hash-link" href="#run-the-felix-bot" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="install-dependencies"></a>Install dependencies<a class="hash-link" href="#install-dependencies" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ https://github.com/zengbing15/felix.git</span></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cd felix </span></span><span class="token-line" style="color:#393A34"><span class="token plain">$ npm install</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="set-up-the-proxy-server"></a>Set up the proxy server<a class="hash-link" href="#set-up-the-proxy-server" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">export https_proxy=http://127.0.0.1:10080;export http_proxy=http://127.0.0.1:10080;export all_proxy=socks5://127.0.0.1:10081</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="set-up-the-bot_token"></a>Set up the BOT_TOKEN<a class="hash-link" href="#set-up-the-bot_token" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ export BOT_TOKEN=`&lt;BOT_TOKEN&gt;`</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="set-up-the-configuration-for-lumos"></a>Set up the Configuration for Lumos<a class="hash-link" href="#set-up-the-configuration-for-lumos" title="Direct link to heading">#</a></h2><p>因为发红包的行为实际上就是个转账交易，要用到 lumos, 所以先配置好 Lumos Config Manager and Lumos Indexer</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">const { Indexer } = require(&quot;@ckb-lumos/indexer&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">const { initializeConfig, getConfig } = require(&quot;@ckb-lumos/config-manager&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">process.env.LUMOS_CONFIG_FILE = process.env.LUMOS_CONFIG_FILE || &#x27;./config.json&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">initializeConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">const CKB_CONFIG = getConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">process.env.LUMOS_CONFIG_FILE = process.env.LUMOS_CONFIG_FILE || &#x27;./config.json&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">initializeConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">const CKB_CONFIG = getConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">const CKB_RPC_URI = process.env.CKB_RPC_URI || &quot;http://127.0.0.1:8114&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">const CKB_INDEXER_DATA = process.env.CKB_INDEXER_DATA || &quot;./indexer-data&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">const indexer = new Indexer(CKB_RPC_URI, CKB_INDEXER_DATA);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">indexer.startForever();</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>For a sender, you can </p><ul><li>/send@botname  send 发红包命令, 能够 Grab 的次数，也就是所显示的 remaining：number 不超过 group chat member</li></ul><p>[Image: image.png]
For a grabber, you can</p><ul><li>set your receiving address: Charlie’s address</li><li>Grab the red package </li></ul><p>[Image: image.png]</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="use-parseaddress-to-confirm-receiving-address"></a>Use <a href="https://nervosnetwork.github.io/lumos/modules/helpers.html#parseaddress" target="_blank" rel="noopener noreferrer">parseAddress</a> to confirm receiving address<a class="hash-link" href="#use-parseaddress-to-confirm-receiving-address" title="Direct link to heading">#</a></h2><p>在 Address and Lock Script 部分，提到 </p><blockquote><p>地址 packages a lock script into a single line in a verifiable and human-readable format.，&quot;ckt&quot; is for the testnet or devchain. </p></blockquote><p>所以使用 <code>parseAddress</code>  对输入的地址进行解析，判断是否 return <code>Script</code>  type, 如果没有，则进行提示，<code>CKB_CONFIG.PREFIX</code>表示了 the  address prefix <code>PREFIX</code> of  current running chain <code>CKB_CONFIG</code> object </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">const {parseAddress} = require(&quot;@ckb-lumos/helpers&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  [DATA_RECEIVING_ADDRESS]: async (session, msg, reply) =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    const address = msg.text || &quot;&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      parseAddress(address);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      console.log(`Error parsing address: ${e}`);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      reply.text(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        `Please use a valid CKB address that starts with ${CKB_CONFIG.PREFIX}!`</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return DATA_RECEIVING_ADDRESS;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    await storage.put(`address:${msg.from.id}`, address);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    reply.text(`Setting your receiving address to ${address}!`);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Felix 通过 grabber 的 <code>Grab </code>行为获得 grabber 的 user.id 和 address</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">  async grab(receiverId, storage) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (this.remaining() &lt;= 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      throw new Error(&quot;You are too late!&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (this.receivers.find((receiver) =&gt; receiver.id === receiverId)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      throw new Error(&quot;You have already grabbed one!&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    let address;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      address = (await storage.get(`address:${receiverId}`)).toString();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      throw new Error(&quot;Please click on me, and set your receiving address in a private chat!&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.receivers.push({</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      id: receiverId,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      address,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>For a sender , you can </p><ul><li>select a envelope to pay</li><li>enter the CKBytes to pay for the red envelope</li><li>enter the address used to pay for the red envelope: Bob’s address</li></ul><p>[Image: image.png]</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="build-the-transaction-skeleton"></a>Build the transaction skeleton<a class="hash-link" href="#build-the-transaction-skeleton" title="Direct link to heading">#</a></h2><p>这时候已经获取到了转账所需的足够的信息（交易双方地址，转账金额），并且查找到需要转账给 Grab 红包的人的 <code>currentAmount</code> ,然后就按步骤 build txSkeleton：</p><ul><li>Create a transaction skeleton</li><li>Add the transaction fee</li><li>Prepare the signing entries </li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">let txSkeleton = TransactionSkeleton({ cellProvider: indexer });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    const fromInfos = [fromAddress]</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      txSkeleton = await common.transfer(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        txSkeleton,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        fromInfos,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        receiver.address,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        currentAmount + BigInt(61) * SHANNONS,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">       // use `payFeeByFeeRate` to set dynamic tx fee</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    txSkeleton = await common.payFeeByFeeRate(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      txSkeleton, </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      fromInfos, </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      FEE_RATE,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    txSkeleton = common.prepareSigningEntries(txSkeleton);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>之后 felix bot reply <code>message</code> in signingEntries object </p><p>[Image: image.png]</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">    ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    const signingInfos = txSkeleton</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      .get(&quot;signingEntries&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      .map((e) =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        const lock = txSkeleton.get(&quot;inputs&quot;).get(e.index).cell_output.lock;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        const address = generateAddress(lock);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return `Address: ${address}\nMessage: ${e.message}`;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      .toArray()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      .join(&quot;\n&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    reply.text(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      `Please sign the following messages required by the transaction:\n\n${signingInfos}\n\nSignatures must be in hex string format with 0x prefix, each different signature should occupy its own line.`</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return DATA_PAY_SIGNING;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="sign-the-transaction-offline"></a>Sign the transaction offline<a class="hash-link" href="#sign-the-transaction-offline" title="Direct link to heading">#</a></h2><p>为了保证安全，Transaction assembling and transaction signing should be separated. It’s recommended to use ckb-cli to sign the transaction  to generate the signature. </p><p>For a grabber, you can</p><ul><li>Use ckb-cli to sign the transaction</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="use-ckb-cli-to-sign-the-transaction"></a>Use ckb-cli to sign the transaction<a class="hash-link" href="#use-ckb-cli-to-sign-the-transaction" title="Direct link to heading">#</a></h3><ul><li>The CKB pre-built installer package includes the ckb-cli tool, see <a href="https://cryptape.github.io/lumos-doc/docs/reference/ckbnode/#step-1-download-the-ckb-pre-built-installer-package" target="_blank" rel="noopener noreferrer">Download the CKB pre-built installer package</a>. </li><li>generate the signature </li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ ckb-cli util sign-message --recoverable --from-account &lt;bob&#x27;s lock_arg&gt; --message &lt;signing message&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The following is a signature output example：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Password: </span></span><span class="token-line" style="color:#393A34"><span class="token plain">path: m</span></span><span class="token-line" style="color:#393A34"><span class="token plain">recoverable: true</span></span><span class="token-line" style="color:#393A34"><span class="token plain">signature: 0xd75d630994f862b43c52dc5dfd22306b9fec4112e751a5daf40fef7da0db05d7506a3494b63d7546dbdd2ea93af61f939d162fe7b8fe45da3ef929493a22762600</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="seal-the-transaction-with-the-generated-signature"></a>Seal the transaction with the generated signature<a class="hash-link" href="#seal-the-transaction-with-the-generated-signature" title="Direct link to heading">#</a></h2><p>For a grabber, you can</p><ul><li>Commit the generated signature to felix bot.</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"> [DATA_PAY_SIGNING]: async (session, msg, reply) =&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    const envelope = session[DATA_PAY];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    const amount = session[DATA_PAY_AMOUNT];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    const txSkeleton = session[DATA_PAY_ADDRESS];</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    console.log(JSON.stringify(txSkeleton,null,2));</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    const signatures = (msg.text || &quot;&quot;).split(&quot;\n&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    let tx;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      tx = sealTransaction(txSkeleton, signatures);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      console.log(`Error sealing transaction: ${e} stack: ${e.stack}`);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      reply.text(&quot;Invalid signatures!&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return DATA_PAY_SIGNING;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="send-the-finalized-transaction-to-the-ckb-network"></a>Send the finalized transaction to the CKB network<a class="hash-link" href="#send-the-finalized-transaction-to-the-ckb-network" title="Direct link to heading">#</a></h2><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">    const txHash = await rpc.send_transaction(tx);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    reply.text(`Envelope successfully paid! TX hash: ${txHash}`);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    delete session[DATA_PAY];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    delete session[DATA_PAY_AMOUNT];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    delete session[DATA_PAY_ADDRESS];</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>[Image: image.png]</p></div><footer class="docusaurus-mt-lg"><div class="row"><div class="col"><a href="https://github.com/facebook/docusaurus/edit/main/website/docs/felixbot-dapp.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/implement-dapp-docs/transfer-tx-dapp-demo"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« A transfer-tx DApp demo</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/implement-dapp-docs/felixbot-confirm-message"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Felix bot: Confirm signing message »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#prerequisites" class="table-of-contents__link">Prerequisites</a><ul><li><a href="#set-up-the-development-environment" class="table-of-contents__link">Set up the Development Environment</a></li><li><a href="#prepare-three-ckb-accounts" class="table-of-contents__link">Prepare three CKB accounts</a></li><li><a href="#设置-alice-作为-devchain-的-miner-to-get-capacity" class="table-of-contents__link">设置 Alice 作为 DevChain 的 miner to get capacity</a></li><li><a href="#use-ckb-cli--to-transfer-some-ckb-tokens-to-bob" class="table-of-contents__link">Use CKB-CLI  to transfer some CKB tokens to Bob</a></li><li><a href="#set-up-a-telegram-bot" class="table-of-contents__link">Set up a telegram bot</a></li></ul></li><li><a href="#run-the-felix-bot" class="table-of-contents__link">Run the felix bot</a><ul><li><a href="#install-dependencies" class="table-of-contents__link">Install dependencies</a></li><li><a href="#set-up-the-proxy-server" class="table-of-contents__link">Set up the proxy server</a></li><li><a href="#set-up-the-bot_token" class="table-of-contents__link">Set up the BOT_TOKEN</a></li></ul></li><li><a href="#set-up-the-configuration-for-lumos" class="table-of-contents__link">Set up the Configuration for Lumos</a></li><li><a href="#use-parseaddress-to-confirm-receiving-address" class="table-of-contents__link">Use parseAddress to confirm receiving address</a></li><li><a href="#build-the-transaction-skeleton" class="table-of-contents__link">Build the transaction skeleton</a></li><li><a href="#sign-the-transaction-offline" class="table-of-contents__link">Sign the transaction offline</a><ul><li><a href="#use-ckb-cli-to-sign-the-transaction" class="table-of-contents__link">Use ckb-cli to sign the transaction</a></li></ul></li><li><a href="#seal-the-transaction-with-the-generated-signature" class="table-of-contents__link">Seal the transaction with the generated signature</a></li><li><a href="#send-the-finalized-transaction-to-the-ckb-network" class="table-of-contents__link">Send the finalized transaction to the CKB network</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/zengbing15/implement-dapp-docs" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://discord.com/invite/AqGTUE9" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://talk.nervos.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Nervos Talk<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://cryptape.github.io/lumos-doc/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Lumos-doc<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 zengbing. Built with Docusaurus.</div></div></div></footer></div>
<script src="/implement-dapp-docs/assets/js/runtime~main.23805c1f.js"></script>
<script src="/implement-dapp-docs/assets/js/main.5e6e0b34.js"></script>
</body>
</html>